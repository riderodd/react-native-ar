{"version":3,"names":["LINKING_ERROR","Platform","select","ios","default","ComponentName","ArViewerComponent","UIManager","getViewManagerConfig","requireNativeComponent","Error","ArViewerView","Component","constructor","props","Map","state","cameraPermission","OS","nativeRef","createRef","_onDataReturned","bind","_onError","componentDidMount","PermissionsAndroid","request","PERMISSIONS","CAMERA","then","granted","RESULTS","GRANTED","setState","nativeEvent","message","event","result","error","requestId","parseInt","promise","_requestMap","get","resolve","reject","delete","console","warn","takeScreenshot","_nextRequestId","requestMap","Promise","set","current","dispatchViewManagerCommand","findNodeHandle","Commands","reset","rotate","pitch","yaw","roll","rotateModel","render"],"sources":["index.tsx"],"sourcesContent":["import React, { Component, createRef, RefObject, SyntheticEvent } from 'react';\r\nimport {\r\n  requireNativeComponent,\r\n  UIManager,\r\n  Platform,\r\n  ViewStyle,\r\n  findNodeHandle,\r\n  HostComponent,\r\n  PermissionsAndroid,\r\n} from 'react-native';\r\n\r\nconst LINKING_ERROR =\r\n  `The package 'react-native-ar-viewer' doesn't seem to be linked. Make sure: \\n\\n` +\r\n  Platform.select({ ios: \"- You have run 'pod install'\\n\", default: '' }) +\r\n  '- You rebuilt the app after installing the package\\n' +\r\n  '- You are not using Expo managed workflow\\n';\r\n\r\ntype ArEvent = SyntheticEvent<\r\n  {},\r\n  {\r\n    requestId: number | string;\r\n    result: string;\r\n    error: string;\r\n  }\r\n>;\r\ntype ArErrorEvent = SyntheticEvent<{}, { message: string }>;\r\ntype ArStatelessEvent = SyntheticEvent<{}, {}>;\r\n\r\ntype ArViewerProps = {\r\n  model: string;\r\n  planeOrientation?: 'none' | 'vertical' | 'horizontal' | 'both';\r\n  allowScale?: boolean;\r\n  allowRotate?: boolean;\r\n  allowTranslate?: boolean;\r\n  lightEstimation?: boolean;\r\n  manageDepth?: boolean;\r\n  disableInstructions?: boolean;\r\n  disableInstantPlacement?: boolean;\r\n  style?: ViewStyle;\r\n  ref?: RefObject<HostComponent<ArViewerProps> | (() => never)>;\r\n  onDataReturned: (e: ArEvent) => void;\r\n  onError?: (e: ArErrorEvent) => void | undefined;\r\n  onStarted?: (e: ArStatelessEvent) => void | undefined;\r\n  onEnded?: (e: ArStatelessEvent) => void | undefined;\r\n  onModelPlaced?: (e: ArStatelessEvent) => void | undefined;\r\n  onModelRemoved?: (e: ArStatelessEvent) => void | undefined;\r\n};\r\n\r\ntype UIManagerArViewer = {\r\n  Commands: {\r\n    takeScreenshot: number;\r\n    reset: number;\r\n    rotateModel: number;\r\n  };\r\n};\r\n\r\ntype ArViewUIManager = UIManager & {\r\n  ArViewerView: UIManagerArViewer;\r\n};\r\n\r\ntype ArInnerViewProps = Omit<\r\n  ArViewerProps,\r\n  'onDataReturned' | 'ref' | 'onError'\r\n>;\r\n\r\ntype ArInnerViewState = {\r\n  cameraPermission: boolean;\r\n};\r\n\r\nconst ComponentName = 'ArViewerView';\r\n\r\nconst ArViewerComponent =\r\n  UIManager.getViewManagerConfig(ComponentName) != null\r\n    ? requireNativeComponent<ArViewerProps>(ComponentName)\r\n    : () => {\r\n        throw new Error(LINKING_ERROR);\r\n      };\r\n\r\nexport class ArViewerView extends Component<\r\n  ArInnerViewProps,\r\n  ArInnerViewState\r\n> {\r\n  // We need to keep track of all running requests, so we store a counter.\r\n  private _nextRequestId = 1;\r\n  // We also need to keep track of all the promises we created so we can\r\n  // resolve them later.\r\n  private _requestMap = new Map<\r\n    number,\r\n    {\r\n      resolve: (result: string) => void;\r\n      reject: (result: string) => void;\r\n    }\r\n  >();\r\n  // Add a ref to the native view component\r\n  private nativeRef: RefObject<HostComponent<ArViewerProps> | (() => never)>;\r\n\r\n  constructor(props: ArInnerViewProps) {\r\n    super(props);\r\n    this.state = {\r\n      cameraPermission: Platform.OS !== 'android',\r\n    };\r\n    this.nativeRef = createRef<typeof ArViewerComponent>();\r\n    // bind methods to current context\r\n    this._onDataReturned = this._onDataReturned.bind(this);\r\n    this._onError = this._onError.bind(this);\r\n  }\r\n\r\n  componentDidMount() {\r\n    if (!this.state.cameraPermission) {\r\n      // asks permissions internally to correct a bug: https://github.com/SceneView/sceneview-android/issues/80\r\n      PermissionsAndroid.request(PermissionsAndroid.PERMISSIONS.CAMERA).then(\r\n        (granted) => {\r\n          if (granted === PermissionsAndroid.RESULTS.GRANTED) {\r\n            this.setState({ cameraPermission: true });\r\n          } else {\r\n            this._onError({\r\n              nativeEvent: { message: 'Cannot start without camera permission' },\r\n            } as ArErrorEvent);\r\n          }\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  _onDataReturned(event: ArEvent) {\r\n    // We grab the relevant data out of our event.\r\n    const { result, error } = event.nativeEvent;\r\n    const requestId = parseInt(event.nativeEvent.requestId as string, 10);\r\n    // Then we get the promise we saved earlier for the given request ID.\r\n    const promise = this._requestMap.get(requestId);\r\n    if (promise) {\r\n      if (result) {\r\n        // If it was successful, we resolve the promise.\r\n        promise.resolve(result);\r\n      } else {\r\n        // Otherwise, we reject it.\r\n        promise.reject(error);\r\n      }\r\n      // Finally, we clean up our request map.\r\n      this._requestMap.delete(requestId);\r\n    }\r\n  }\r\n\r\n  _onError(event: ArErrorEvent) {\r\n    // We grab the relevant data out of our event.\r\n    const { message } = event.nativeEvent;\r\n    console.warn(message);\r\n  }\r\n\r\n  /**\r\n   * Takes a full screenshot of the rendered camera\r\n   * @returns A promise resolving a base64 encoded image\r\n   */\r\n  takeScreenshot() {\r\n    // Grab a new request ID and our request map.\r\n    let requestId = this._nextRequestId++;\r\n    let requestMap = this._requestMap;\r\n\r\n    // We create a promise here that will be resolved once `_onRequestDone` is\r\n    // called.\r\n    let promise = new Promise<string>(function (resolve, reject) {\r\n      requestMap.set(requestId, { resolve: resolve, reject: reject });\r\n    });\r\n\r\n    // Now just dispatch the command as before, adding the request ID to the\r\n    // parameters.\r\n    this.nativeRef.current &&\r\n      UIManager.dispatchViewManagerCommand(\r\n        findNodeHandle(this.nativeRef.current as unknown as number),\r\n        (UIManager as ArViewUIManager)[ComponentName].Commands.takeScreenshot,\r\n        [requestId]\r\n      );\r\n    return promise;\r\n  }\r\n\r\n  /**\r\n   * Reset the model positionning\r\n   * @returns void\r\n   */\r\n  reset() {\r\n    this.nativeRef.current &&\r\n      UIManager.dispatchViewManagerCommand(\r\n        findNodeHandle(this.nativeRef.current as unknown as number),\r\n        (UIManager as ArViewUIManager)[ComponentName].Commands.reset,\r\n        []\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Rotate the model\r\n   * @returns void\r\n   */\r\n  rotate(pitch: number, yaw: number, roll: number) {\r\n    this.nativeRef.current &&\r\n      UIManager.dispatchViewManagerCommand(\r\n        findNodeHandle(this.nativeRef.current as unknown as number),\r\n        (UIManager as ArViewUIManager)[ComponentName].Commands.rotateModel,\r\n        [pitch, yaw, roll]\r\n      );\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      this.state.cameraPermission && (\r\n        <ArViewerComponent\r\n          ref={this.nativeRef}\r\n          onDataReturned={this._onDataReturned}\r\n          onError={this._onError}\r\n          {...this.props}\r\n        />\r\n      )\r\n    );\r\n  }\r\n}\r\n"],"mappings":"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"}